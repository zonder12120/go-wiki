---
order: 8
title: Goрутины и каналы (доделать)
---

## Вступление

Я не буду рассказывать про горутины с простого их использования, потому что в таком случае будет соблазн просто писать перед функцией `go` и забить на то, как это реально внутри исполняется. Более того, лично мне проще понимать, как что-то использовать, когда я знаю, как это устроено внутри, такой подход позволяет избегать множества не очевидных, но весьма простых ошибок. А так как я тут пишу материал в первую очередь от себя и для себя, то будь по-моему.

Не бойся, я постараюсь как можно нагляднее и проще тебе рассказать про то, как горутинки исполняются в рантайме.

Стоп! Тут некоторые могут понимать примерно, что такое рантайм, но не представлять его предметно, хотя это было бы кстати для изучения работы планировщика, ща быстренько исправим.

Я где-то могу ошибаться, ты просто добавляй **issue** с указанием ошибки и со ссылкой на **правильный** материал.

:::info:true Что такое Runtime, зачем нужен, из чего состоит

## Что такое Runtime?

**Runtime** -- это среда исполнения программы, которая предоставляет необходимые инструменты и сервисы для выполнения программы на компьютере. Рантайм работает во время исполнения скомпилированного кода на процессоре.

### Компоненты Go runtime:

1. **Планировщик (Scheduler)**\
   Управляет выполнением горутин, их созданием, приостановкой и планированием на потоках операционной системы.

2. **Аллокатор памяти (Memory Allocator)**\
   Отвечает за выделение и освобождение памяти для выполнения программ Go.

3. **Сборщик мусора (Garbage Collector, GC)**\
   Автоматически освобождает память, которая больше не используется, обеспечивая эффективное управление памятью.

4. **P (Процессор, Processor)**\
   Виртуальная логическая единица, которая распределяет горутины на исполнение, контролируя их выполнение и помогая рантайму эффективно использовать M (машины) для выполнения множества горутин.

   Число P обычно равно числу логических процессоров, доступных для приложения, но оно может быть настроено с использованием функции `runtime.GOMAXPROCS()`.

5. **M (Машина, Machine)**\
   Поток ОС, который используется для выполнения горутин.

6. **G (Горутина, Goroutine)**\
   Структура данных, представляющая горутину, содержащая состояние выполнения и стек.

7. **Локальное хранилище потоков (Thread Local Storage)**\
   **TLS** -- это механизм, позволяющий каждому потоку хранить свои уникальные данные. Эти данные остаются привязанными к потоку,

8. **Netpoller**\
   Управляет асинхронными операциями ввода-вывода, обеспечивая возможность горутинам ожидать сетевых и других событий без блокировки.

### Процессы, управляемые рантаймом:

1. **Управление горутинами (Goroutine Management)**\
   Рантайм управляет созданием, выполнением, приостановкой и возобновлением горутин.

2. **Управление стеком (Stack Management)**\
   Рантайм динамически управляет стеками горутин, расширяя или уменьшая их по мере необходимости.

3. **Обработка сигналов (Signal Handling)**\
   Управляет системными сигналами (например, прерываниями) и их распределением для работы горутин.

4. **Рефлексия в рантайме (Runtime Reflection)**\
   Позволяет программе динамически анализировать и изменять структуры данных и типы во время выполнения программы.

5. **Таймеры (Timers)**\
   Рантайм управляет таймерами для выполнения операций с временными задержками, таких как `time.Sleep` и другие функции, связанные с временем.

6. **Обработка panic и recover**\
   Рантайм управляет механизмами для обработки исключений (panic) и их восстановления (recover), что необходимо для управления ошибками в Go.

7. **Синхронизация (Synchronization)**\
   Рантайм управляет внутренними примитивами синхронизации, такими как мьютексы и каналы.

8. **Механизм трассировки (Tracing Mechanism)**\
   Рантайм предоставляет возможности для трассировки и профилирования выполнения программы.

9. **Управление памятью (Memory Management)**\
   Включает управление выделением и освобождением памяти, а также поддержку различных стратегий управления кэшем и памяти.

10. **Планирование асинхронных задач (Asynchronous Task Scheduling)**\
    Управляет асинхронными задачами, связанными с операциями ввода-вывода и другими долгосрочными задачами.

11. **Детектирование гонок (Race Detection):**

    В режиме разработки доступен механизм, который может обнаруживать состояния гонки при использовании горутин, что помогает в выработке более безопасного параллельного кода.

12. **Автоматическая оптимизация производительности и использования памяти:**

    Рантайм Go выполняет внутренние оптимизации, чтобы улучшать общую производительность программы и минимизировать использование ресурсов.

:::

Сам runtime языка описан здесь: <https://github.com/golang/go/tree/master/src/runtime>


